import streamlit as st
import pandas as pd

# ë°ì´í„° ë¡œë”© í•¨ìˆ˜ (ë‹¤ë¥¸ í˜ì´ì§€ì™€ ìºì‹œ ê³µìœ )
@st.cache_data
def load_data():
    """
    ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ê¸°ë³¸ì ì¸ ì „ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
    """
    dtype_spec = {'í˜¸ì„ ëª…': str, 'ì§€í•˜ì² ì—­': str}
    try:
        df = pd.read_csv('ì§€í•˜ì² ë°ì´í„°.csv', encoding='cp949', dtype=dtype_spec)
    except UnicodeDecodeError:
        df = pd.read_csv('ì§€í•˜ì² ë°ì´í„°.csv', encoding='utf-8-sig', dtype=dtype_spec)
    except FileNotFoundError:
        st.error("ğŸ˜¥ 'ì§€í•˜ì² ë°ì´í„°.csv' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì— íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
        return None
    
    df.dropna(subset=['í˜¸ì„ ëª…', 'ì§€í•˜ì² ì—­'], inplace=True)
    df = df.iloc[:, :-1]
    
    col_names = ['ì‚¬ìš©ì›”', 'í˜¸ì„ ëª…', 'ì—­ID', 'ì§€í•˜ì² ì—­']
    for i in range(4, len(df.columns), 2):
        time_str = df.columns[i].split('~')[0][:2]
        col_names.append(f'{time_str}_ìŠ¹ì°¨')
        col_names.append(f'{time_str}_í•˜ì°¨')
    df.columns = col_names
    
    value_cols = [c for c in df.columns if '_ìŠ¹ì°¨' in c or '_í•˜ì°¨' in c]
    for col in value_cols:
        if df[col].dtype == 'object':
            df[col] = pd.to_numeric(df[col].str.replace(',', ''), errors='coerce').fillna(0).astype(int)
        else:
            df[col] = df[col].fillna(0).astype(int)
    return df

# --- ë©”ì¸ í˜ì´ì§€ UI ---
st.set_page_config(
    page_title="ì„œìš¸ ì§€í•˜ì²  ë°ì´í„° ë¶„ì„",
    page_icon="ğŸš‡",
    layout="wide",
)

st.title("ğŸš‡ ì„œìš¸ ì§€í•˜ì²  ë°ì´í„° ë¶„ì„ ëŒ€ì‹œë³´ë“œ")
st.markdown("ì´ ëŒ€ì‹œë³´ë“œëŠ” ì„œìš¸ ì§€í•˜ì² ì˜ ì‹œê°„ëŒ€ë³„ ì´ìš© í˜„í™© ë°ì´í„°ë¥¼ ì‹œê°ì ìœ¼ë¡œ ë¶„ì„í•˜ê³  íƒìƒ‰í•˜ê¸° ìœ„í•´ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.")
st.markdown("ì™¼ìª½ ì‚¬ì´ë“œë°” ë©”ë‰´ë¥¼ í†µí•´ ë‹¤ì–‘í•œ ë¶„ì„ í˜ì´ì§€ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
st.markdown("---")


# --- í˜ì´ì§€ë³„ ì‚¬ìš© ì„¤ëª…ì„œ ---
st.header("ğŸ“Š í˜ì´ì§€ë³„ ì‚¬ìš© ì„¤ëª…ì„œ")

st.info("""
**ğŸ’¡ ê³µí†µ ê¸°ëŠ¥: ë™ì¼ ì—­ëª… ë°ì´í„° í•©ì‚°**\n
ëŒ€ë¶€ë¶„ì˜ í˜ì´ì§€ì—ëŠ” **'ë™ì¼ ì—­ëª… ë°ì´í„° í•©ì‚°'** ì²´í¬ë°•ìŠ¤ê°€ ìˆìŠµë‹ˆë‹¤. 
ì´ ì˜µì…˜ì„ ì„ íƒí•˜ë©´ 'ê°•ë‚¨(2í˜¸ì„ )', 'ê°•ë‚¨(ì‹ ë¶„ë‹¹ì„ )'ì²˜ëŸ¼ ë‚˜ë‰˜ì–´ ìˆëŠ” í™˜ìŠ¹ì—­ ë°ì´í„°ë¥¼ í•˜ë‚˜ì˜ **'ê°•ë‚¨ (í†µí•©)'** ë°ì´í„°ë¡œ í•©ì‚°í•˜ì—¬ ë¶„ì„í•©ë‹ˆë‹¤.
""")

col1, col2, col3 = st.columns(3)
with col1:
    with st.container(border=True):
        st.subheader("1. ì‹œê°„ëŒ€ë³„ í˜¼ì¡ ë¶„ì„")
        st.markdown("- **ë¬´ì—‡ì„ í•˜ë‚˜ìš”?**: íŠ¹ì • ì‹œê°„ëŒ€ë¥¼ ì„ íƒí•˜ì—¬ ê°€ì¥ ë¶ë¹„ëŠ” ì—­ì˜ ìˆœìœ„ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.")
        st.markdown("- **ì‚¬ìš© ë°©ë²•**: ìŠ¬ë¼ì´ë”ë¥¼ ì¡°ì ˆí•´ ì›í•˜ëŠ” ì‹œê°„ê³¼ ìˆœìœ„(TOP N)ë¥¼ ì„ íƒí•˜ì„¸ìš”. ìŠ¹ì°¨/í•˜ì°¨ ì¸ì› ê·¸ë˜í”„ê°€ ê°ê° í‘œì‹œë©ë‹ˆë‹¤.")

    with st.container(border=True):
        st.subheader("2. ìœ ë™ì¸êµ¬ ë¶„ì„")
        st.markdown("- **ë¬´ì—‡ì„ í•˜ë‚˜ìš”?**: í•˜ë£¨ ì´ ìŠ¹í•˜ì°¨ ì¸ì›ì´ ê°€ì¥ ë§ì€ ì—­ì˜ ìˆœìœ„ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.")
        st.markdown("- **ì‚¬ìš© ë°©ë²•**: ì „ì²´ ë˜ëŠ” íŠ¹ì • í˜¸ì„ ì„ ì„ íƒí•˜ê³ , ìŠ¬ë¼ì´ë”ë¡œ ë³´ê³  ì‹¶ì€ ìˆœìœ„(TOP N)ë¥¼ ì¡°ì ˆí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

with col2:
    with st.container(border=True):
        st.subheader("3. íŒ¨í„´ ìœ ì‚¬ì—­ ë¶„ì„")
        st.markdown("- **ë¬´ì—‡ì„ í•˜ë‚˜ìš”?**: íŠ¹ì • ì—­ê³¼ ì‹œê°„ëŒ€ë³„ ì´ìš© íŒ¨í„´(í•˜ë£¨ì˜ ë¦¬ë“¬)ì´ ê°€ì¥ ë¹„ìŠ·í•œ ì—­ì„ ì°¾ìŠµë‹ˆë‹¤.")
        st.markdown("- **ì‚¬ìš© ë°©ë²•**: ê¸°ì¤€ ì—­, ë¶„ì„ ì¢…ë¥˜(ì¢…í•©/ìŠ¹ì°¨/í•˜ì°¨), ë¹„êµí•  ì—­ì˜ ê°œìˆ˜(TOP N)ë¥¼ ì„ íƒí•˜ì„¸ìš”. ì¸ì› ë¹„ìœ¨ íŒ¨í„´ì„ ê·¸ë˜í”„ë¡œ ë¹„êµí•˜ê³  ìœ ì‚¬ë„ ìˆœìœ„ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

    with st.container(border=True):
        st.subheader("4. ì‹œê°„ëŒ€ë³„ ì „ì²´ìˆœìœ„ ë¶„ì„")
        st.markdown("- **ë¬´ì—‡ì„ í•˜ë‚˜ìš”?**: ê° ì‹œê°„ëŒ€ì˜ 'ì±”í”¼ì–¸' (ê°€ì¥ ì´ìš©ê°ì´ ë§ì€ ì—­)ì´ ì–´ë–»ê²Œ ë³€í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.")
        st.markdown("- **ì‚¬ìš© ë°©ë²•**: ë§‰ëŒ€ê·¸ë˜í”„ë¡œ ì‹œê°„ì˜ íë¦„ì— ë”°ë¥¸ 1ìœ„ ì—­ì˜ ë³€í™”ë¥¼ íƒìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

with col3:
    with st.container(border=True):
        st.subheader("5. ë‘ ì—­ ë¹„êµ ë¶„ì„")
        st.markdown("- **ë¬´ì—‡ì„ í•˜ë‚˜ìš”?**: ë¹„êµí•˜ê³  ì‹¶ì€ ë‘ ì—­ì„ ì§ì ‘ ì„ íƒí•˜ì—¬ ì‹œê°„ëŒ€ë³„ ìŠ¹í•˜ì°¨ ì¸ì› ì¶”ì´ë¥¼ ë‚˜ë€íˆ ë¹„êµí•©ë‹ˆë‹¤.")
        st.markdown("- **ì‚¬ìš© ë°©ë²•**: ë‘ ê°œì˜ ì„ íƒ ìƒìì—ì„œ ê°ê° ì›í•˜ëŠ” ì—­ì„ ê³ ë¥´ë©´, ìŠ¹ì°¨ ë° í•˜ì°¨ ë°ì´í„° ë¹„êµ ê·¸ë˜í”„ê°€ ì¦‰ì‹œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.")


# --- ë°ì´í„° ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ ---
st.markdown("---")
st.header("ğŸ’¾ ì›ë³¸ ë°ì´í„° í™•ì¸ ë° ë‹¤ìš´ë¡œë“œ")
df = load_data()
if df is not None:
    st.dataframe(df.head(10))
    
    # ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•œ CSV ë³€í™˜ í•¨ìˆ˜
    @st.cache_data
    def convert_df_to_csv(df):
        return df.to_csv(index=False).encode('utf-8-sig')

    csv_data = convert_df_to_csv(df)
    
    st.download_button(
       label="ğŸ“Š ì „ì²˜ë¦¬ëœ ë°ì´í„° ë‹¤ìš´ë¡œë“œ (CSV)",
       data=csv_data,
       file_name='seoul_metro_processed.csv',
       mime='text/csv',
    )

